# SonnenBackup

Read from the real-time API on Sonnen Batterie to manage Backup Reserve use.

Readonly API, use Sonnen Batterie portal or mobile app to set Backup Reserve percent.

* System state On Grid, Off Grid or Critical Error.
* Real time power, current and voltage
* Battery levels, Charge/Discharge rate, time to fully charged
* Backup reserve, time to reserve, time to fully discharged
* Temperature and batterie health


## HACS

Install SonnenBackup integration.

Uses sonnen_api_v2 driver package which requires a readonly API Token created in the
Sonnen management portal.

Configuration will require the IP address of the battery device and the API token generated by the management portal.
If the battery portal uses a non-standard port, other than 80, that can be configured too.
It does not support https (port 443) using a self-signed certificate.

## Usage

install sonnenbackup with hacs
HASS Sensor is the name used for Home Assistant from the driver package property call Package Sensor.

## Sensors

| Package Sensor                | Unit  | HASS sensor        |
|------------------------------:|------:|-------------------:|
|battery_activity_state|string|sonnenbackup_state|
|configuration_de_software|string|firmware_version|
|configuration_em_operatingmode|string|operating_mode|
|led_state|string|led_state|
|led_state_text|string|led_state_text|
|state_bms|string|state_bms|
|state_inverter|string|state_inverter|
|system_status|string|system_status|
|battery_cycle_count|integer|battery_cycle_count|
|battery_average_current|A|battery_average_current|
|backup_buffer_capacity_wh|Wh|reserve_capacity|
|battery_full_charge_capacity_wh|Wh|full_charge_capacity|
|battery_unusable_capacity_wh|Wh|unusable_capacity|
|capacity_to_reserve|Wh|capacity_to_reserve|
|capacity_until_reserve|Wh|capacity_until_reserve|
|usable_remaining_capacity_wh|Wh|usable_capacity|
|remaining_capacity_wh|Wh|remaining_capacity|
|used_capacity|Wh|used_capacity|
|kwh_consumed|kWh|kwh_consumed|
|kwh_produced|kWh|kwh_produced|
|status_frequency|hertz|frequency|
|battery_dod_limit|percent|depth_of_discharge_limit|
|battery_rsoc|percent|relative_state_of_charge|
|battery_usoc|percent|usable_state_of_charge|
|status_backup_buffer|percent|reserve_charge|
|charging|watts|charge_power|
|consumption|watts|consumption_now|
|consumption_average |watts|consumption_average|
|consumption_total_w|watts|consumption_daily|
|discharging|watts|discharge_power|
|inverter_pac_total|watts|ongrid_pac|
|inverter_pac_microgrid|watts|offgrid_pac|
|production|watts|production_now|
|production_total_w|watts|production_daily|
|status_grid_export|watts|grid_export|
|status_grid_import|watts|grid_import|
|battery_min_cell_temp|celsius|min_battery_temp|
|battery_max_cell_temp|celsius|max_battery_temp|
|system_status_timestamp|timestamp|status_timestamp|
|fully_charged_at|timestamp|fully_charged_at|
|fully_discharged_at|timestamp|fully_discharged_at|
|backup_reserve_at|timestamp|reserve_at|
|last_time_full|timestamp|last_time_full|
|last_updated|timestamp|last_updated|
|time_since_full|deltatime|interval_since_full|
|dc_minimum_rsoc_reached|bool|dc_minimum_rsoc|
|mg_minimum_soc_reached|bool|microgrid_minimum_soc|
|microgrid_enabled|bool|microgrid_enabled|
|status_battery_charging|bool|is_charging|
|status_battery_discharging|bool|is_discharging|


Some sensors have enumerated values:

```
system_status: ["Config", "OnGrid", "OffGrid", "Critical Error"]
sonnenbackup_state: ["standby", "charging", "discharging", "discharging reserve", "charged", "discharged"]
operating_mode: {1: "Manual", 2: "Automatic", 6: "Extension module", 10: "Time of Use"}
```

### sonnenbackup_state
"standby" indicates the battery is neither charging nor discharging.
The battery could be fully charged, fully discharged or at back reserve limit.
Must be read in conjuction with "relative_state_of_charge" to determine the reason for "standby".

### Timestamps
Sensors fully charged, fully discharged & backup reserve are calculated on current consumption/production.
When battery is in standby, these timestamp values are undefined, as will some when charging/discharging.
Times are calculated relative to Sonnen batterie server time, which is "system_status_timestamp".
A slight discrpency will be apparent if hass server time and batterie time are different.

### led_state
Sensor indicates the state of the status LED on the side of the battery.
Only one element may be True, that element, with brightness, is returned as a string.
e.g 'Pulsing White 100%'
```
"Eclipse Led":{
    "Blinking Red":true,   # undocumented - call installer
    "Brightness":100,
    "Pulsing Green":true,  # Off Grid, in MicroGrid (backup) mode
    "Pulsing Orange":true, # no internet connection
    "Pulsing White":true,  # normal operation
    "Solid Red":true       # serious problem - call installer
}
```
All values False indicates Off Grid operation, the string "Off Grid." is returned.

### State of Charge
The batterie reports two State of Charge values, Relative and Usable. The difference between these two values is reported by
sensor depth_of_discharge_limit. Depth of Discharge reserve is included in Relative State of Charge (RSoC) overall values, like full_charge_capacity.
Specific usable values are based on Usable State of Charge (USoC), like usable_capacity.

Importantly, the reserve_charge percent for backup buffer is based on USoC. eg when sensor sonnenbackup_state is 'standby' USoC equals Backup Reserve Charge, a little less than RSoC.

## Recording
Some sensor values do not change, some only change when configuration changes, some are of little value when not current. These sensors will waste space if recorded.

Suggested recording exclusions in configuration.yaml:
```
# Recorder filter to exclude specified entities, change placeholder names
# your actual sensor names. eg "sonnenbackup.backupbatterie_nnnnnn_sonnenbackup_full_charge_capacity"
#   where 'nnnnnn' is the battery serial number entered on the config form.
recorder:
  exclude:
    entities:
      - sonnenbackup.full_charge_capacity
      - sonnenbackup.led_state
      - sonnenbackup.led_state_text
      - sonnenbackup.backup_reserve_capacity
      - sonnenbackup.status_frequency
      - sonnenbackup.backup_reserve_percent
      - sonnenbackup.state_bms
      - sonnenbackup.state_inverter
      - sonnenbackup.seconds_since_full
      - sonnenbackup.seconds_until_fully_charged
      - sonnenbackup.seconds_until_fully_discharged
      - sonnenbackup.seconds_until_reserve
      - sonnenbackup.system_status_timestamp
      - sonnenbackup.fully_charged_at
      - sonnenbackup.fully_discharged_at
      - sonnenbackup.backup_reserve_at
      - sonnenbackup.last_time_full
      - sonnenbackup.last_updated
      - sonnenbackup.time_since_full
      - sonnenbackup.operating_mode
```

## Confirmed Supported Batteries

These batteries have been tested and confirmed to be working. If your batterie is not listed below, this library may still work provided your battery admin portal can generate an API read token and responds to Sonnen API V2 endpoints.
API token will return status 401 if used with V1 of the API. Use Weltmyer sonnenbatterie package if user/password authentication is required.

* Power unit Evo IP56
